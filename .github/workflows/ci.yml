name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.compiler }} - ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        build_type: [Release, Debug]
        exclude:
          # macOS uses clang by default
          - os: macos-latest
            compiler: gcc
          # Only test Debug on Linux with GCC to save CI time
          - os: macos-latest
            build_type: Debug
          - os: ubuntu-latest
            compiler: clang
            build_type: Debug

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          libyaml-cpp-dev \
          libnetcdf-dev \
          libhdf5-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install \
          cmake \
          yaml-cpp \
          netcdf \
          hdf5

    - name: Set up compiler (GCC)
      if: matrix.compiler == 'gcc' && runner.os == 'Linux'
      run: |
        echo "CC=gcc" >> $GITHUB_ENV
        echo "CXX=g++" >> $GITHUB_ENV

    - name: Set up compiler (Clang)
      if: matrix.compiler == 'clang'
      run: |
        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV

    - name: Configure CMake (Basic)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_NETCDF=AUTO \
          -DNDARRAY_USE_HDF5=AUTO \
          -DNDARRAY_USE_YAML=AUTO

    - name: Build
      run: cmake --build build -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  build-minimal:
    name: Minimal build (no dependencies)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install minimal dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake

    - name: Configure CMake (Minimal)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_NETCDF=OFF \
          -DNDARRAY_USE_HDF5=OFF \
          -DNDARRAY_USE_ADIOS2=OFF \
          -DNDARRAY_USE_MPI=OFF \
          -DNDARRAY_USE_VTK=OFF \
          -DNDARRAY_USE_YAML=OFF

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  # code-style:
  #   name: Code style check
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v3
  #
  #   - name: Check for common issues
  #     run: |
  #       # Check for trailing whitespace in include and test directories
  #       if git grep -I -n '[[:blank:]]$' -- 'include/**/*.cpp' 'include/**/*.hh' 'include/**/*.h' 'tests/*.cpp' 'tests/*.hh' 'tests/*.h' 'src/*.cpp' 2>/dev/null; then
  #         echo "Found trailing whitespace in source files"
  #         exit 1
  #       fi
  #
  #       # Check for tabs (prefer spaces)
  #       if git grep -I -n $'\t' -- 'include/**/*.cpp' 'include/**/*.hh' 'include/**/*.h' 'tests/*.cpp' 'tests/*.hh' 'tests/*.h' 'src/*.cpp' 2>/dev/null; then
  #         echo "Found tabs in source files, prefer spaces"
  #         exit 1
  #       fi
  #
  #       echo "Code style checks passed"

  build-cuda:
    name: CUDA build (Ubuntu)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Cache CUDA
      id: cache-cuda
      uses: actions/cache@v3
      with:
        path: /usr/local/cuda-12.0
        key: cuda-12.0-ubuntu2204

    - name: Install CUDA Toolkit
      if: steps.cache-cuda.outputs.cache-hit != 'true'
      run: |
        wget https://developer.download.nvidia.com/compute/cuda/12.0.0/local_installers/cuda_12.0.0_525.60.13_linux.run
        sudo sh cuda_12.0.0_525.60.13_linux.run --silent --toolkit --override
        # The runfile installer by default installs to /usr/local/cuda-12.0

    - name: Set CUDA Path
      run: |
        echo "/usr/local/cuda-12.0/bin" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=/usr/local/cuda-12.0/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "CUDA_PATH=/usr/local/cuda-12.0" >> $GITHUB_ENV
        echo "CUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-12.0" >> $GITHUB_ENV

    - name: Configure CMake (CUDA)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_CUDA=ON \
          -DNDARRAY_USE_MPI=OFF \
          -DNDARRAY_USE_YAML=OFF \
          -DCMAKE_CUDA_COMPILER=/usr/local/cuda-12.0/bin/nvcc \
          -DCMAKE_CUDA_FLAGS="-allow-unsupported-compiler"

    - name: Build
      run: cmake --build build -j$(nproc)

  build-mpi:
    name: MPI build (Ubuntu)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          libyaml-cpp-dev \
          libnetcdf-dev \
          libhdf5-dev \
          libhdf5-mpich-dev \
          mpich \
          libmpich-dev

    - name: Configure CMake (MPI)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_MPI=ON \
          -DNDARRAY_USE_NETCDF=AUTO \
          -DNDARRAY_USE_HDF5=AUTO \
          -DNDARRAY_USE_YAML=AUTO

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run serial tests
      working-directory: build
      run: ctest --output-on-failure -E "distributed|ghost_exchange|mpi"

    - name: Check if MPI tests exist
      id: check_mpi_tests
      working-directory: build
      run: |
        if [ -f bin/test_distributed_ndarray ]; then
          echo "has_mpi_tests=true" >> $GITHUB_OUTPUT
        else
          echo "has_mpi_tests=false" >> $GITHUB_OUTPUT
        fi

    - name: Run MPI tests
      if: steps.check_mpi_tests.outputs.has_mpi_tests == 'true'
      working-directory: build
      run: |
        echo "Running MPI tests with MPICH..."
        # Run distributed tests with different rank counts
        for np in 2 4; do
          echo "Testing with $np ranks..."
          mpirun -np $np bin/test_distributed_ndarray || {
            echo "MPI test with $np ranks failed"
            exit 1
          }
        done
        echo "All MPI tests passed"

  build-storage-backends:
    name: Storage backends (Eigen + xtensor)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          libyaml-cpp-dev \
          libeigen3-dev

    - name: Install xtensor (header-only library)
      run: |
        # Install xtl 0.7.x (compatible with C++17)
        echo "Installing xtl 0.7.5..."
        git clone --depth 1 --branch 0.7.5 https://github.com/xtensor-stack/xtl.git
        cd xtl
        mkdir build && cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
        sudo make install
        cd ../..

        # Verify xtl installation
        if [ -d "/usr/local/include/xtl" ]; then
          echo "✓ xtl installed successfully to /usr/local/include/xtl"
          ls /usr/local/include/xtl/*.hpp | head -5
        else
          echo "✗ xtl installation failed!"
          exit 1
        fi

        # Install xtensor 0.24.x (compatible with C++17)
        echo "Installing xtensor 0.24.7..."
        git clone --depth 1 --branch 0.24.7 https://github.com/xtensor-stack/xtensor.git
        cd xtensor
        mkdir build && cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
        sudo make install
        cd ../..

        # Verify xtensor installation
        if [ -d "/usr/local/include/xtensor" ]; then
          echo "✓ xtensor installed successfully to /usr/local/include/xtensor"
          ls /usr/local/include/xtensor/*.hpp | head -5
          ls /usr/local/include/xtensor/xarray.hpp || echo "✗ xarray.hpp not found!"
        else
          echo "✗ xtensor installation failed!"
          exit 1
        fi

    - name: Configure CMake (Storage backends)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH=/usr/local \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_EIGEN=AUTO \
          -DNDARRAY_USE_XTENSOR=AUTO \
          -DNDARRAY_USE_YAML=AUTO

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  build-sanitizers:
    name: Build with sanitizers (Ubuntu + Clang)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          clang \
          libyaml-cpp-dev

    - name: Configure CMake (AddressSanitizer)
      run: |
        export CC=clang
        export CXX=clang++
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_YAML=AUTO \
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g"

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests with AddressSanitizer
      working-directory: build
      run: ASAN_OPTIONS=detect_leaks=1 ctest --output-on-failure

  build-pnetcdf:
    name: PNetCDF (Parallel NetCDF)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          mpich \
          libmpich-dev \
          m4 \
          automake \
          autoconf \
          libtool

    - name: Cache PNetCDF
      id: cache-pnetcdf
      uses: actions/cache@v3
      with:
        path: ~/pnetcdf
        key: pnetcdf-1.12.3-${{ runner.os }}

    - name: Build and install PNetCDF
      if: steps.cache-pnetcdf.outputs.cache-hit != 'true'
      run: |
        # Download PNetCDF
        wget https://parallel-netcdf.github.io/Release/pnetcdf-1.12.3.tar.gz
        tar -xzf pnetcdf-1.12.3.tar.gz
        cd pnetcdf-1.12.3

        # Configure and build (install to ~/pnetcdf for caching)
        ./configure --prefix=$HOME/pnetcdf --enable-shared
        make -j$(nproc)
        make install
        cd ..

    - name: Set up PNetCDF environment
      run: |
        echo "$HOME/pnetcdf/bin" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=$HOME/pnetcdf/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

    - name: Configure CMake (PNetCDF)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH=$HOME/pnetcdf \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_MPI=ON \
          -DNDARRAY_USE_PNETCDF=ON

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure -E "distributed|ghost"

  build-png:
    name: PNG support (libpng)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          libpng-dev

    - name: Configure CMake (PNG)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_PNG=ON

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  build-all-formats:
    name: All I/O formats (NetCDF+HDF5+YAML+PNG)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          libyaml-cpp-dev \
          libnetcdf-dev \
          libhdf5-dev \
          libpng-dev

    - name: Configure CMake (All formats)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_NETCDF=ON \
          -DNDARRAY_USE_HDF5=ON \
          -DNDARRAY_USE_YAML=ON \
          -DNDARRAY_USE_PNG=ON

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  build-vtk:
    name: VTK support
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install minimal dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake

    - name: Cache VTK
      id: cache-vtk
      uses: actions/cache@v3
      with:
        path: ~/vtk
        key: vtk-9.6.0-minimal-v2-${{ runner.os }}

    - name: Build and install VTK from source
      if: steps.cache-vtk.outputs.cache-hit != 'true'
      run: |
        # Download VTK 9.6.0
        wget https://www.vtk.org/files/release/9.6/VTK-9.6.0.tar.gz
        tar -xzf VTK-9.6.0.tar.gz
        cd VTK-9.6.0

        # Configure minimal VTK build (no Qt, no Python, no MPI, no OpenGL2)
        mkdir build && cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=$HOME/vtk \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_TESTING=OFF \
          -DVTK_GROUP_ENABLE_Rendering=NO \
          -DVTK_GROUP_ENABLE_StandAlone=WANT \
          -DVTK_MODULE_ENABLE_VTK_CommonCore=YES \
          -DVTK_MODULE_ENABLE_VTK_CommonDataModel=YES \
          -DVTK_MODULE_ENABLE_VTK_IOXML=YES \
          -DVTK_MODULE_ENABLE_VTK_IOLegacy=YES \
          -DVTK_MODULE_ENABLE_VTK_FiltersCore=YES \
          -DVTK_WRAP_PYTHON=OFF \
          -DVTK_USE_MPI=OFF

        # Build and install
        make -j$(nproc)
        make install
        cd ../..

    - name: Set up VTK environment
      run: |
        echo "VTK_DIR=$HOME/vtk/lib/cmake/vtk-9.6" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=$HOME/vtk/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

    - name: Clean build directory
      run: rm -rf build

    - name: Configure CMake (VTK)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH=$HOME/vtk \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_VTK=ON \
          -DNDARRAY_USE_MPI=OFF

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  build-cpp-standards:
    name: C++ Standard ${{ matrix.std }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        std: [17, 20]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++-11 \
          libyaml-cpp-dev \
          libnetcdf-dev \
          libhdf5-dev

    - name: Set up compiler
      run: |
        echo "CC=gcc-11" >> $GITHUB_ENV
        echo "CXX=g++-11" >> $GITHUB_ENV

    - name: Configure CMake (C++${{ matrix.std }})
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_STANDARD=${{ matrix.std }} \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_NETCDF=AUTO \
          -DNDARRAY_USE_HDF5=AUTO \
          -DNDARRAY_USE_YAML=AUTO

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  documentation:
    name: Check documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Verify documentation files exist
      run: |
        test -f README.md || (echo "README.md missing" && exit 1)
        test -f CHANGELOG.md || (echo "CHANGELOG.md missing" && exit 1)
        test -f CONTRIBUTING.md || (echo "CONTRIBUTING.md missing" && exit 1)
        test -f LICENSE || (echo "LICENSE missing" && exit 1)
        echo "All required documentation files present"

    - name: Check for broken links in README
      run: |
        # Basic check for common markdown issues
        grep -n '](http' README.md || echo "No external links found"
        grep -n ']\[' README.md && (echo "Found undefined link references" && exit 1) || true
        echo "Documentation checks passed"
