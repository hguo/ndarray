name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          # macOS uses clang by default
          - os: macos-latest
            compiler: gcc

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          libyaml-cpp-dev \
          libnetcdf-dev \
          libhdf5-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install \
          cmake \
          yaml-cpp \
          netcdf \
          hdf5

    - name: Set up compiler (GCC)
      if: matrix.compiler == 'gcc' && runner.os == 'Linux'
      run: |
        echo "CC=gcc" >> $GITHUB_ENV
        echo "CXX=g++" >> $GITHUB_ENV

    - name: Set up compiler (Clang)
      if: matrix.compiler == 'clang'
      run: |
        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV

    - name: Configure CMake (Basic)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_NETCDF=AUTO \
          -DNDARRAY_USE_HDF5=AUTO \
          -DNDARRAY_USE_YAML=AUTO

    - name: Build
      run: cmake --build build -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  build-minimal:
    name: Minimal build (no dependencies)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install minimal dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake

    - name: Configure CMake (Minimal)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_NETCDF=OFF \
          -DNDARRAY_USE_HDF5=OFF \
          -DNDARRAY_USE_ADIOS2=OFF \
          -DNDARRAY_USE_MPI=OFF \
          -DNDARRAY_USE_VTK=OFF \
          -DNDARRAY_USE_YAML=OFF

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  # code-style:
  #   name: Code style check
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v3
  #
  #   - name: Check for common issues
  #     run: |
  #       # Check for trailing whitespace in include and test directories
  #       if git grep -I -n '[[:blank:]]$' -- 'include/**/*.cpp' 'include/**/*.hh' 'include/**/*.h' 'tests/*.cpp' 'tests/*.hh' 'tests/*.h' 'src/*.cpp' 2>/dev/null; then
  #         echo "Found trailing whitespace in source files"
  #         exit 1
  #       fi
  #
  #       # Check for tabs (prefer spaces)
  #       if git grep -I -n $'\t' -- 'include/**/*.cpp' 'include/**/*.hh' 'include/**/*.h' 'tests/*.cpp' 'tests/*.hh' 'tests/*.h' 'src/*.cpp' 2>/dev/null; then
  #         echo "Found tabs in source files, prefer spaces"
  #         exit 1
  #       fi
  #
  #       echo "Code style checks passed"

  build-mpi:
    name: MPI build (Ubuntu)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          libyaml-cpp-dev \
          libnetcdf-dev \
          libhdf5-dev \
          libhdf5-mpi-dev \
          libhdf5-openmpi-dev \
          libopenmpi-dev \
          openmpi-bin

    - name: Configure CMake (MPI)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_MPI=ON \
          -DNDARRAY_USE_NETCDF=AUTO \
          -DNDARRAY_USE_HDF5=AUTO \
          -DNDARRAY_USE_YAML=AUTO

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run serial tests
      working-directory: build
      run: ctest --output-on-failure -E "distributed|ghost_exchange|mpi"

    - name: Run MPI tests
      working-directory: build
      run: |
        # Run distributed tests with different rank counts
        for np in 2 4; do
          echo "Testing with $np ranks..."
          if [ -f bin/test_distributed_ndarray ]; then
            mpirun --oversubscribe -np $np bin/test_distributed_ndarray || exit 1
          fi
        done

  build-storage-backends:
    name: Storage backends (Eigen + xtensor)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          libyaml-cpp-dev \
          libeigen3-dev

    - name: Install xtensor (header-only library)
      run: |
        # Install xtl 0.7.x (compatible with C++17)
        git clone --depth 1 --branch 0.7.5 https://github.com/xtensor-stack/xtl.git /tmp/xtl
        cd /tmp/xtl
        cmake -B build -DCMAKE_INSTALL_PREFIX=/usr
        sudo cmake --build build --target install

        # Install xtensor 0.24.x (compatible with C++17)
        git clone --depth 1 --branch 0.24.7 https://github.com/xtensor-stack/xtensor.git /tmp/xtensor
        cd /tmp/xtensor
        cmake -B build -DCMAKE_INSTALL_PREFIX=/usr
        sudo cmake --build build --target install

        # Verify installation
        ls -la /usr/include/xtl/ || echo "xtl headers not found"
        ls -la /usr/include/xtensor/ || echo "xtensor headers not found"

    - name: Configure CMake (Storage backends)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_EIGEN=AUTO \
          -DNDARRAY_USE_XTENSOR=AUTO \
          -DNDARRAY_USE_YAML=AUTO

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

  build-sanitizers:
    name: Build with sanitizers (Ubuntu + Clang)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          clang \
          libyaml-cpp-dev

    - name: Configure CMake (AddressSanitizer)
      run: |
        export CC=clang
        export CXX=clang++
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DNDARRAY_BUILD_TESTS=ON \
          -DNDARRAY_BUILD_EXAMPLES=OFF \
          -DNDARRAY_USE_YAML=AUTO \
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g"

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run tests with AddressSanitizer
      working-directory: build
      run: ASAN_OPTIONS=detect_leaks=1 ctest --output-on-failure

  documentation:
    name: Check documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Verify documentation files exist
      run: |
        test -f README.md || (echo "README.md missing" && exit 1)
        test -f CHANGELOG.md || (echo "CHANGELOG.md missing" && exit 1)
        test -f CONTRIBUTING.md || (echo "CONTRIBUTING.md missing" && exit 1)
        test -f LICENSE || (echo "LICENSE missing" && exit 1)
        echo "All required documentation files present"

    - name: Check for broken links in README
      run: |
        # Basic check for common markdown issues
        grep -n '](http' README.md || echo "No external links found"
        grep -n ']\[' README.md && (echo "Found undefined link references" && exit 1) || true
        echo "Documentation checks passed"
